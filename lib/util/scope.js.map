{"version":3,"names":["Scope","var","Set","lexical","functions","constructor","flags","ScopeHandler","parser","scopeStack","inModule","undefinedExports","Map","inFunction","currentVarScopeFlags","SCOPE_FUNCTION","allowSuper","currentThisScopeFlags","SCOPE_SUPER","allowDirectSuper","SCOPE_DIRECT_SUPER","inClass","SCOPE_CLASS","inClassAndNotInNonArrowFunction","inStaticBlock","i","length","SCOPE_STATIC_BLOCK","SCOPE_VAR","inNonArrowFunction","treatFunctionsAsVar","treatFunctionsAsVarInScope","currentScope","createScope","enter","push","exit","scope","pop","SCOPE_PROGRAM","declareName","name","bindingType","loc","BIND_SCOPE_LEXICAL","BIND_SCOPE_FUNCTION","checkRedeclarationInScope","add","maybeExportDefined","BIND_SCOPE_VAR","delete","isRedeclaredInScope","raise","Errors","VarRedeclaration","at","identifierName","BIND_KIND_VALUE","has","SCOPE_SIMPLE_CATCH","values","next","value","checkLocalExport","id","topLevelScope","set","start","SCOPE_ARROW"],"sources":["../../src/util/scope.ts"],"sourcesContent":["import {\n  SCOPE_ARROW,\n  SCOPE_DIRECT_SUPER,\n  SCOPE_FUNCTION,\n  SCOPE_SIMPLE_CATCH,\n  SCOPE_SUPER,\n  SCOPE_PROGRAM,\n  SCOPE_VAR,\n  SCOPE_CLASS,\n  SCOPE_STATIC_BLOCK,\n  BIND_SCOPE_FUNCTION,\n  BIND_SCOPE_VAR,\n  BIND_SCOPE_LEXICAL,\n  BIND_KIND_VALUE,\n  type ScopeFlags,\n  type BindingTypes,\n} from \"./scopeflags\";\nimport { Position } from \"./location\";\nimport * as N from \"../types\";\nimport { Errors } from \"../parse-error\";\nimport Tokenizer from \"../tokenizer\";\n\n// Start an AST node, attaching a start offset.\nexport class Scope {\n  declare flags: ScopeFlags;\n  // A set of var-declared names in the current lexical scope\n  var: Set<string> = new Set();\n  // A set of lexically-declared names in the current lexical scope\n  lexical: Set<string> = new Set();\n  // A set of lexically-declared FunctionDeclaration names in the current lexical scope\n  functions: Set<string> = new Set();\n\n  constructor(flags: ScopeFlags) {\n    this.flags = flags;\n  }\n}\n\n// The functions in this module keep track of declared variables in the\n// current scope in order to detect duplicate variable names.\nexport default class ScopeHandler<IScope extends Scope = Scope> {\n  parser: Tokenizer;\n  scopeStack: Array<IScope> = [];\n  inModule: boolean;\n  undefinedExports: Map<string, Position> = new Map();\n\n  constructor(parser: Tokenizer, inModule: boolean) {\n    this.parser = parser;\n    this.inModule = inModule;\n  }\n\n  get inFunction() {\n    return (this.currentVarScopeFlags() & SCOPE_FUNCTION) > 0;\n  }\n  get allowSuper() {\n    return (this.currentThisScopeFlags() & SCOPE_SUPER) > 0;\n  }\n  get allowDirectSuper() {\n    return (this.currentThisScopeFlags() & SCOPE_DIRECT_SUPER) > 0;\n  }\n  get inClass() {\n    return (this.currentThisScopeFlags() & SCOPE_CLASS) > 0;\n  }\n  get inClassAndNotInNonArrowFunction() {\n    const flags = this.currentThisScopeFlags();\n    return (flags & SCOPE_CLASS) > 0 && (flags & SCOPE_FUNCTION) === 0;\n  }\n  get inStaticBlock() {\n    for (let i = this.scopeStack.length - 1; ; i--) {\n      const { flags } = this.scopeStack[i];\n      if (flags & SCOPE_STATIC_BLOCK) {\n        return true;\n      }\n      if (flags & (SCOPE_VAR | SCOPE_CLASS)) {\n        // function body, module body, class property initializers\n        return false;\n      }\n    }\n  }\n  get inNonArrowFunction() {\n    return (this.currentThisScopeFlags() & SCOPE_FUNCTION) > 0;\n  }\n  get treatFunctionsAsVar() {\n    return this.treatFunctionsAsVarInScope(this.currentScope());\n  }\n\n  createScope(flags: ScopeFlags): Scope {\n    return new Scope(flags);\n  }\n\n  enter(flags: ScopeFlags) {\n    /*:: +createScope: (flags: ScopeFlags) => IScope; */\n    // @ts-expect-error This method will be overwritten by subclasses\n    this.scopeStack.push(this.createScope(flags));\n  }\n\n  exit(): ScopeFlags | void {\n    const scope = this.scopeStack.pop();\n    return scope.flags;\n  }\n\n  // The spec says:\n  // > At the top level of a function, or script, function declarations are\n  // > treated like var declarations rather than like lexical declarations.\n  treatFunctionsAsVarInScope(scope: IScope): boolean {\n    return !!(\n      scope.flags & (SCOPE_FUNCTION | SCOPE_STATIC_BLOCK) ||\n      (!this.parser.inModule && scope.flags & SCOPE_PROGRAM)\n    );\n  }\n\n  declareName(name: string, bindingType: BindingTypes, loc: Position) {\n    let scope = this.currentScope();\n    if (bindingType & BIND_SCOPE_LEXICAL || bindingType & BIND_SCOPE_FUNCTION) {\n      this.checkRedeclarationInScope(scope, name, bindingType, loc);\n\n      if (bindingType & BIND_SCOPE_FUNCTION) {\n        scope.functions.add(name);\n      } else {\n        scope.lexical.add(name);\n      }\n\n      if (bindingType & BIND_SCOPE_LEXICAL) {\n        this.maybeExportDefined(scope, name);\n      }\n    } else if (bindingType & BIND_SCOPE_VAR) {\n      for (let i = this.scopeStack.length - 1; i >= 0; --i) {\n        scope = this.scopeStack[i];\n        this.checkRedeclarationInScope(scope, name, bindingType, loc);\n        scope.var.add(name);\n        this.maybeExportDefined(scope, name);\n\n        if (scope.flags & SCOPE_VAR) break;\n      }\n    }\n    if (this.parser.inModule && scope.flags & SCOPE_PROGRAM) {\n      this.undefinedExports.delete(name);\n    }\n  }\n\n  maybeExportDefined(scope: IScope, name: string) {\n    if (this.parser.inModule && scope.flags & SCOPE_PROGRAM) {\n      this.undefinedExports.delete(name);\n    }\n  }\n\n  checkRedeclarationInScope(\n    scope: IScope,\n    name: string,\n    bindingType: BindingTypes,\n    loc: Position,\n  ) {\n    if (this.isRedeclaredInScope(scope, name, bindingType)) {\n      this.parser.raise(Errors.VarRedeclaration, {\n        at: loc,\n        identifierName: name,\n      });\n    }\n  }\n\n  isRedeclaredInScope(\n    scope: IScope,\n    name: string,\n    bindingType: BindingTypes,\n  ): boolean {\n    if (!(bindingType & BIND_KIND_VALUE)) return false;\n\n    if (bindingType & BIND_SCOPE_LEXICAL) {\n      return (\n        scope.lexical.has(name) ||\n        scope.functions.has(name) ||\n        scope.var.has(name)\n      );\n    }\n\n    if (bindingType & BIND_SCOPE_FUNCTION) {\n      return (\n        scope.lexical.has(name) ||\n        (!this.treatFunctionsAsVarInScope(scope) && scope.var.has(name))\n      );\n    }\n\n    return (\n      (scope.lexical.has(name) &&\n        !(\n          scope.flags & SCOPE_SIMPLE_CATCH &&\n          scope.lexical.values().next().value === name\n        )) ||\n      (!this.treatFunctionsAsVarInScope(scope) && scope.functions.has(name))\n    );\n  }\n\n  checkLocalExport(id: N.Identifier) {\n    const { name } = id;\n    const topLevelScope = this.scopeStack[0];\n    if (\n      !topLevelScope.lexical.has(name) &&\n      !topLevelScope.var.has(name) &&\n      // In strict mode, scope.functions will always be empty.\n      // Modules are strict by default, but the `scriptMode` option\n      // can overwrite this behavior.\n      !topLevelScope.functions.has(name)\n    ) {\n      this.undefinedExports.set(name, id.loc.start);\n    }\n  }\n\n  currentScope(): IScope {\n    return this.scopeStack[this.scopeStack.length - 1];\n  }\n\n  currentVarScopeFlags(): ScopeFlags {\n    for (let i = this.scopeStack.length - 1; ; i--) {\n      const { flags } = this.scopeStack[i];\n      if (flags & SCOPE_VAR) {\n        return flags;\n      }\n    }\n  }\n\n  // Could be useful for `arguments`, `this`, `new.target`, `super()`, `super.property`, and `super[property]`.\n  currentThisScopeFlags(): ScopeFlags {\n    for (let i = this.scopeStack.length - 1; ; i--) {\n      const { flags } = this.scopeStack[i];\n      if (flags & (SCOPE_VAR | SCOPE_CLASS) && !(flags & SCOPE_ARROW)) {\n        return flags;\n      }\n    }\n  }\n}\n"],"mappings":"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"}