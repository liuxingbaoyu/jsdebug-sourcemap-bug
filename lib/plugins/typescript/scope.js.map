{"version":3,"names":["TypeScriptScope","Scope","types","Set","enums","constEnums","classes","exportOnlyBindings","TypeScriptScopeHandler","ScopeHandler","importsStack","createScope","flags","push","enter","SCOPE_TS_MODULE","exit","pop","hasImport","name","allowShadow","len","length","has","declareName","bindingType","loc","BIND_FLAGS_TS_IMPORT","parser","raise","Errors","VarRedeclaration","at","identifierName","add","scope","currentScope","BIND_FLAGS_TS_EXPORT_ONLY","maybeExportDefined","BIND_KIND_TYPE","BIND_KIND_VALUE","checkRedeclarationInScope","BIND_FLAGS_TS_ENUM","BIND_FLAGS_TS_CONST_ENUM","BIND_FLAGS_CLASS","isRedeclaredInScope","isConst","wasConst","lexical","checkLocalExport","id","topLevelScope","scopeStack"],"sources":["../../../src/plugins/typescript/scope.ts"],"sourcesContent":["import { Position } from \"../../util/location\";\nimport ScopeHandler, { Scope } from \"../../util/scope\";\nimport {\n  BIND_KIND_TYPE,\n  BIND_FLAGS_TS_ENUM,\n  BIND_FLAGS_TS_CONST_ENUM,\n  BIND_FLAGS_TS_EXPORT_ONLY,\n  BIND_KIND_VALUE,\n  BIND_FLAGS_CLASS,\n  type ScopeFlags,\n  type BindingTypes,\n  BIND_FLAGS_TS_IMPORT,\n  SCOPE_TS_MODULE,\n} from \"../../util/scopeflags\";\nimport * as N from \"../../types\";\nimport { Errors } from \"../../parse-error\";\n\nclass TypeScriptScope extends Scope {\n  types: Set<string> = new Set();\n\n  // enums (which are also in .types)\n  enums: Set<string> = new Set();\n\n  // const enums (which are also in .enums and .types)\n  constEnums: Set<string> = new Set();\n\n  // classes (which are also in .lexical) and interface (which are also in .types)\n  classes: Set<string> = new Set();\n\n  // namespaces and ambient functions (or classes) are too difficult to track,\n  // especially without type analysis.\n  // We need to track them anyway, to avoid \"X is not defined\" errors\n  // when exporting them.\n  exportOnlyBindings: Set<string> = new Set();\n}\n\n// See https://github.com/babel/babel/pull/9766#discussion_r268920730 for an\n// explanation of how typescript handles scope.\n\nexport default class TypeScriptScopeHandler extends ScopeHandler<TypeScriptScope> {\n  importsStack: Set<string>[] = [];\n\n  createScope(flags: ScopeFlags): TypeScriptScope {\n    this.importsStack.push(new Set()); // SCOPE_TS_TOP_LEVEL should be kept\n\n    return new TypeScriptScope(flags);\n  }\n\n  enter(flags: number): void {\n    if (flags == SCOPE_TS_MODULE) {\n      this.importsStack.push(new Set());\n    }\n\n    super.enter(flags);\n  }\n\n  exit() {\n    const flags = super.exit();\n\n    if (flags == SCOPE_TS_MODULE) {\n      this.importsStack.pop();\n    }\n  }\n\n  hasImport(name: string, allowShadow?: boolean) {\n    const len = this.importsStack.length;\n    if (this.importsStack[len - 1].has(name)) {\n      return true;\n    }\n    return !allowShadow && len > 1 && this.importsStack[0].has(name);\n  }\n\n  declareName(name: string, bindingType: BindingTypes, loc: Position) {\n    if (bindingType & BIND_FLAGS_TS_IMPORT) {\n      if (this.hasImport(name, true)) {\n        this.parser.raise(Errors.VarRedeclaration, {\n          at: loc,\n          identifierName: name,\n        });\n      }\n      this.importsStack[this.importsStack.length - 1].add(name);\n      return;\n    }\n\n    const scope = this.currentScope();\n    if (bindingType & BIND_FLAGS_TS_EXPORT_ONLY) {\n      this.maybeExportDefined(scope, name);\n      scope.exportOnlyBindings.add(name);\n      return;\n    }\n\n    super.declareName(name, bindingType, loc);\n\n    if (bindingType & BIND_KIND_TYPE) {\n      if (!(bindingType & BIND_KIND_VALUE)) {\n        // \"Value\" bindings have already been registered by the superclass.\n        this.checkRedeclarationInScope(scope, name, bindingType, loc);\n        this.maybeExportDefined(scope, name);\n      }\n      scope.types.add(name);\n    }\n    if (bindingType & BIND_FLAGS_TS_ENUM) scope.enums.add(name);\n    if (bindingType & BIND_FLAGS_TS_CONST_ENUM) scope.constEnums.add(name);\n    if (bindingType & BIND_FLAGS_CLASS) scope.classes.add(name);\n  }\n\n  isRedeclaredInScope(\n    scope: TypeScriptScope,\n    name: string,\n    bindingType: BindingTypes,\n  ): boolean {\n    if (scope.enums.has(name)) {\n      if (bindingType & BIND_FLAGS_TS_ENUM) {\n        // Enums can be merged with other enums if they are both\n        //  const or both non-const.\n        const isConst = !!(bindingType & BIND_FLAGS_TS_CONST_ENUM);\n        const wasConst = scope.constEnums.has(name);\n        return isConst !== wasConst;\n      }\n      return true;\n    }\n    if (bindingType & BIND_FLAGS_CLASS && scope.classes.has(name)) {\n      if (scope.lexical.has(name)) {\n        // Classes can be merged with interfaces\n        return !!(bindingType & BIND_KIND_VALUE);\n      } else {\n        // Interface can be merged with other classes or interfaces\n        return false;\n      }\n    }\n    if (bindingType & BIND_KIND_TYPE && scope.types.has(name)) {\n      return true;\n    }\n\n    return super.isRedeclaredInScope(scope, name, bindingType);\n  }\n\n  checkLocalExport(id: N.Identifier) {\n    const topLevelScope = this.scopeStack[0];\n    const { name } = id;\n    if (\n      !topLevelScope.types.has(name) &&\n      !topLevelScope.exportOnlyBindings.has(name) &&\n      !this.hasImport(name)\n    ) {\n      super.checkLocalExport(id);\n    }\n  }\n}\n"],"mappings":"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"}