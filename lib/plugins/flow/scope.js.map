{"version":3,"names":["FlowScope","Scope","declareFunctions","Set","FlowScopeHandler","ScopeHandler","createScope","flags","declareName","name","bindingType","loc","scope","currentScope","BIND_FLAGS_FLOW_DECLARE_FN","checkRedeclarationInScope","maybeExportDefined","add","isRedeclaredInScope","has","lexical","functions","checkLocalExport","id","scopeStack"],"sources":["../../../src/plugins/flow/scope.ts"],"sourcesContent":["import { Position } from \"../../util/location\";\nimport ScopeHandler, { Scope } from \"../../util/scope\";\nimport {\n  BIND_FLAGS_FLOW_DECLARE_FN,\n  type ScopeFlags,\n  type BindingTypes,\n} from \"../../util/scopeflags\";\nimport * as N from \"../../types\";\n\n// Reference implementation: https://github.com/facebook/flow/blob/23aeb2a2ef6eb4241ce178fde5d8f17c5f747fb5/src/typing/env.ml#L536-L584\nclass FlowScope extends Scope {\n  // declare function foo(): type;\n  declareFunctions: Set<string> = new Set();\n}\n\nexport default class FlowScopeHandler extends ScopeHandler<FlowScope> {\n  createScope(flags: ScopeFlags): FlowScope {\n    return new FlowScope(flags);\n  }\n\n  declareName(name: string, bindingType: BindingTypes, loc: Position) {\n    const scope = this.currentScope();\n    if (bindingType & BIND_FLAGS_FLOW_DECLARE_FN) {\n      this.checkRedeclarationInScope(scope, name, bindingType, loc);\n      this.maybeExportDefined(scope, name);\n      scope.declareFunctions.add(name);\n      return;\n    }\n\n    super.declareName(name, bindingType, loc);\n  }\n\n  isRedeclaredInScope(\n    scope: FlowScope,\n    name: string,\n    bindingType: BindingTypes,\n  ): boolean {\n    if (super.isRedeclaredInScope(scope, name, bindingType)) return true;\n\n    if (bindingType & BIND_FLAGS_FLOW_DECLARE_FN) {\n      return (\n        !scope.declareFunctions.has(name) &&\n        (scope.lexical.has(name) || scope.functions.has(name))\n      );\n    }\n\n    return false;\n  }\n\n  checkLocalExport(id: N.Identifier) {\n    if (!this.scopeStack[0].declareFunctions.has(id.name)) {\n      super.checkLocalExport(id);\n    }\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AAKA;;AAGA,MAAMA,SAAN,SAAwBC,YAAxB,CAA8B;EAE5BC,gBAAgB,GAAgB,IAAIC,GAAJ,EAAhB;AAFY;;AAKf,MAAMC,gBAAN,SAA+BC,cAA/B,CAAuD;EACpEC,WAAW,CAACC,KAAD,EAA+B;IACxC,OAAO,IAAIP,SAAJ,CAAcO,KAAd,CAAP;EACD;;EAEDC,WAAW,CAACC,IAAD,EAAeC,WAAf,EAA0CC,GAA1C,EAAyD;IAClE,MAAMC,KAAK,GAAG,KAAKC,YAAL,EAAd;;IACA,IAAIH,WAAW,GAAGI,sCAAlB,EAA8C;MAC5C,KAAKC,yBAAL,CAA+BH,KAA/B,EAAsCH,IAAtC,EAA4CC,WAA5C,EAAyDC,GAAzD;MACA,KAAKK,kBAAL,CAAwBJ,KAAxB,EAA+BH,IAA/B;MACAG,KAAK,CAACV,gBAAN,CAAuBe,GAAvB,CAA2BR,IAA3B;MACA;IACD;;IAED,MAAMD,WAAN,CAAkBC,IAAlB,EAAwBC,WAAxB,EAAqCC,GAArC;EACD;;EAEDO,mBAAmB,CACjBN,KADiB,EAEjBH,IAFiB,EAGjBC,WAHiB,EAIR;IACT,IAAI,MAAMQ,mBAAN,CAA0BN,KAA1B,EAAiCH,IAAjC,EAAuCC,WAAvC,CAAJ,EAAyD,OAAO,IAAP;;IAEzD,IAAIA,WAAW,GAAGI,sCAAlB,EAA8C;MAC5C,OACE,CAACF,KAAK,CAACV,gBAAN,CAAuBiB,GAAvB,CAA2BV,IAA3B,CAAD,KACCG,KAAK,CAACQ,OAAN,CAAcD,GAAd,CAAkBV,IAAlB,KAA2BG,KAAK,CAACS,SAAN,CAAgBF,GAAhB,CAAoBV,IAApB,CAD5B,CADF;IAID;;IAED,OAAO,KAAP;EACD;;EAEDa,gBAAgB,CAACC,EAAD,EAAmB;IACjC,IAAI,CAAC,KAAKC,UAAL,CAAgB,CAAhB,EAAmBtB,gBAAnB,CAAoCiB,GAApC,CAAwCI,EAAE,CAACd,IAA3C,CAAL,EAAuD;MACrD,MAAMa,gBAAN,CAAuBC,EAAvB;IACD;EACF;;AAtCmE"}